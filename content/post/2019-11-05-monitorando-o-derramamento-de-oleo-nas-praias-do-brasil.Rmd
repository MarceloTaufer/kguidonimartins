---
title: Monitorando o derramamento de óleo nas praias do Brasil
author: ''
date: '2019-11-05'
slug: monitorando-o-derramamento-de-oleo-nas-praias-do-brasil
categories: []
tags: []
description: ''
topics: []
---

<html>
    <link rel="stylesheet" href="/themes/style.css" />
</html>

**Última atualização em**: `r format(Sys.time(), '%d de %B de %Y às %X')`

***

Ontem eu fiz o deploy de um relatório sobre o monitoramento do óleo em praias brasileiras usando o github pages. Hoje, fui atualizar os dados e o novo deploy não foi atualizado. Decidi hospedar esse relatório aqui no meu site pessoal. Em breve, vou postar outro texto com os detalhes técnicos de como fazer um relatório desse tipo usando o R.

Os dados podem ser coletados aqui: http://www.ibama.gov.br/manchasdeoleo-localidades-atingidas

O código que produz este relatório pode ser encontrado aqui: https://github.com/kguidonimartins/scrape_derramamento_de_oleo_br

A única diferença dos dados usados aqui dos dados originais é a transformação das coordenadas geográficas de **graus, minutos e segundos** para **graus decimais**.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = FALSE, message = "hide")

############################################################
#                                                          #
#                  instalação dos pacotes                  #
#                                                          #
############################################################

# ipak function: install and load multiple R packages.
# Check to see if packages are installed. 
# Install them if they are not, then load them into the R session.
# Forked from: https://gist.github.com/stevenworthington/3178163
ipak <- function(pkg) {
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)){
    install.packages(new.pkg, dependencies = TRUE)
  }
  suppressPackageStartupMessages(sapply(pkg, require, character.only = TRUE))
}

ipak(c("tidyverse", "tidylog", "readxl", "here", "biogeo", "plotly", "fs", "tools", "rvest", "widgetframe"))


############################################################
#                                                          #
#                    download dos dados                    #
#                                                          #
############################################################


get_data <- function(dest_folder){
  if (!dir.exists(dest_folder)){
    dir.create(dest_folder)
  }
  
  url_for_link <- "http://www.ibama.gov.br/manchasdeoleo-localidades-atingidas"
  
  url_for_download <- "http://www.ibama.gov.br"
  
  files <- 
    url_for_link %>% 
    read_html() %>% 
    html_nodes("td:nth-child(2) a") %>% 
    html_attr("href") %>% 
    tibble() %>% 
    set_names("link") %>%
    mutate(
      file = basename(link),
      file_type = file_ext(file)
    ) %>% 
    filter(file_type == "xlsx") 
  
  last_file_on_web <- files %>% 
    slice(1) %>% 
    pull(file)
  
  link_for_the_last_file <- files %>% 
    slice(1) %>% 
    pull(link) %>% 
    paste0(url_for_download, .)
  
  dest_and_name <- paste0(dest_folder, "/", last_file_on_web)
  
  if (!file.exists(dest_and_name)){
    download.file(url = link_for_the_last_file, destfile = dest_and_name)
  } else {
    message("Arquivo ", dest_and_name, " já existe")
  }
}

get_data(dest_folder = "data-raw-oleo")

############################################################
#                                                          #
#               leitura e limpeza dos dados                #
#                                                          #
############################################################

last_file_on_local_folder <- 
  dir_info(here::here("content", "post", "data-raw-oleo")) %>% 
  mutate(file_type = file_ext(path)) %>% 
  arrange(desc(birth_time)) %>% 
  filter(file_type == "xlsx") %>% 
  slice(1) %>% 
  pull(path)

df <- 
  read_xlsx(path = last_file_on_local_folder) %>% 
  rename_all(str_to_lower)

clean_coord <- function(coord){
  
  if (grepl(pattern = "[A-Z]", x = coord)){
    coord <- iconv(coord, "utf-8", "ascii", sub="") %>% {
      gsub(pattern = "(')|(\")", replacement = "", x = .)
    }
  } else {
    coord <- coord
  }
  
  return(coord)
}

df_clean <- 
  suppressWarnings(
  df %>% 
  mutate(
    latitude = clean_coord(latitude),
    longitude = clean_coord(longitude)
    ) %>% 
  separate(
    col = latitude, 
    into = c("lat_graus", "lat_minutos", "lat_segundos", "lat_letra"), 
    sep = " ", 
    remove = FALSE,
    convert = TRUE, 
    extra = "drop"
    ) %>%
  separate(
    col = longitude, 
    into = c("long_graus", "long_minutos", "long_segundos", "long_letra"), 
    sep = " ", 
    remove = FALSE,
    convert = TRUE, 
    extra = "drop"
    ) %>% 
  mutate(
    latitude = if_else(
      condition = is.na(lat_letra), 
      true = latitude, 
      false = as.character(
        dms2dd( 
          dd = lat_graus,  
          mm = lat_minutos,  
          ss = lat_segundos,  
          ns = lat_letra
          )
        )
      ),
    longitude = if_else(
      condition = is.na(long_letra), 
      true = longitude, false = as.character(
        dms2dd( 
          dd = long_graus,  
          mm = long_minutos,  
          ss = long_segundos,  
          ns = long_letra
        )
      )
    ),
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude)
    ) %>% 
  dplyr::select(-starts_with("lat_"), -starts_with("long_")) 
)

dir_create(here::here("content", "post", "data-clean-oleo"))

file_to_save <- 
  last_file_on_local_folder %>% 
  basename() %>% 
  gsub(".xlsx", "", .) %>% 
  paste0(., ".csv") %>% 
  paste0("data-clean-oleo/", .)

if (!file.exists(file_to_save)){
  df_clean %>% 
    write_csv(file_to_save)
} else {
  message("Arquivo ", file_to_save, " já existe")
}




ipak <- function(pkg) {
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)){
    install.packages(new.pkg, dependencies = TRUE)
  }
  suppressPackageStartupMessages(sapply(pkg, require, character.only = TRUE))
}

ipak(
  c(
    "tidyverse",
    "tidylog",
    "fs",
    "here",
    "tools",
    "plotly",
    "DT",
    "leaflet",
    "mapview",
    "leafem",
    "leafpop",
    "raster",
    "lubridate"
  )
)

theme_set(theme_light(base_size = 14))

render_table <- function(data){
  datatable(
  data,
  rownames = TRUE,
  filter = "top",
  options = list(
    pageLength = 10, 
    scrollX = TRUE, 
    columnDefs = list(
      list(
        className = 'dt-center', 
        targets = 5)),
     pageLength = 5, lengthMenu = c(5, 10, 15, 20)),
  class = 'cell-border stripe',
  fillContainer = TRUE
) %>% 
    frameWidget(height = 500, width = '100%')
}
```

<!-- *** -->

<!-- # Localidades monitoradas -->

```{r, eval = TRUE, message = FALSE}
last_file_on_local_folder <-
  dir_info(here::here("content", "post", "data-clean-oleo")) %>% 
  mutate(file_type = file_ext(path)) %>% 
  arrange(desc(birth_time)) %>% 
  filter(file_type == "csv") %>% 
  slice(1) %>% 
  pull(path)

df <- read_csv(last_file_on_local_folder) %>% 
  rename(
    Localidade = name,
    `Município` = `município`,
    Estado = estado,
    Status = status
  ) %>% 
  mutate(
      `intervalo entre visitas (em dias)` = as.period(x = data_avist %--% data_revis, unit = "day"),
      `intervalo entre visitas (em dias)` = str_extract(`intervalo entre visitas (em dias)`, "[0-9]+")
      ) %>% 
  dplyr::select(
    Localidade,
    `Município`,
    Estado,
    data_avist,
    data_revis,
    `intervalo entre visitas (em dias)`,
    latitude,
    longitude,
    Status
  )

# render_table(df) 
```

<!-- *** -->
<!-- # Localidades monitoradas por Estado -->

```{r, eval = FALSE, message = FALSE, fig.height=5, fig.width=7}
df %>% 
  group_by(Estado, Status) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(Estado = fct_reorder(Estado, n)) %>% 
  ggplot(aes(x = Estado, y = n)) +
  geom_col() +
  coord_flip() +
  labs(
    x = "",
    y = "Número de registros",
    # title = "Registros por Estado", 
    caption = "Fonte: http://www.ibama.gov.br/manchasdeoleo-localidades-atingidas"
  ) + 
  facet_wrap( ~Status)
```

<!-- *** -->

# Mapa interativo das localidades monitoradas

Clique nos círculos para ter acesso às informações da localidade.

```{r, eval = TRUE, fig.height=6, fig.width=9}
pal <- colorFactor(palette = c("black", "grey", "green"), domain = df$Status)
extensao <- raster::extent(sp::SpatialPoints(df[, c("longitude", "latitude")]))

mapa_oleo <- leaflet(df) %>%
  addTiles() %>%
  addCircleMarkers(
      lng = ~ longitude,
      lat = ~ latitude,
      popup = ~popupTable(
        x = df, 
        zcol = c("Localidade", "Município", "Estado", "Status", "data_avist", "data_revis", "intervalo entre visitas (em dias)"), 
        row.numbers = FALSE, 
        feature.id = FALSE
        ),
      stroke = FALSE, 
      radius = 10, 
      fillOpacity = 0.7,
      color = ~pal(Status)
      ) %>% 
  addLegend(position = "bottomright", pal = pal, values = ~Status, opacity = 1) %>% 
  addMouseCoordinates() %>% 
  addMiniMap(position = "bottomleft") %>% 
  addHomeButton(ext = extensao, layer.name = "Visão geral")

mapa_oleo
```

<!-- *** -->

<!-- # Locais revisitados -->

```{r, eval = FALSE}
# df %>% 
#   filter(!is.na(data_revis)) %>% 
#   render_table() 
```

<!-- *** -->

<!-- # Locais revisitados que não têm óleo -->

```{r, eval = FALSE}
# df %>% 
#   filter(!is.na(data_revis), Status == "Óleo - Não Observado") %>% 
#   render_table()
```

<!-- *** -->

<!-- # Locais revisitados que ainda têm óleo -->

```{r, eval = FALSE}
# df %>% 
#   filter(!is.na(data_revis), Status %in% c("Oleada - Vestígios/Esparsos", "Oleada - Manchas")) %>% 
#   render_table()
```

<!-- *** -->

<!-- # Locais que não foram revisitados e que não têm óleo -->

```{r, eval = FALSE}
# df %>% 
#   filter(is.na(data_revis), Status == "Óleo - Não Observado") %>% 
#   render_table()
```

<!-- *** -->

<!-- # Locais que não foram revisitados e que têm óleo -->

```{r, eval = FALSE}
# df %>% 
#   filter(is.na(data_revis), Status %in% c("Oleada - Vestígios/Esparsos", "Oleada - Manchas")) %>% 
#   render_table() 
```



